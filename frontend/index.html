<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>React + Flask (no build)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>body{font-family:system-ui,sans-serif;max-width:640px;margin:2rem auto}</style>
  </head>
  <body>
    <h1>React + Flask</h1>
    <div id="root">Loading...</div>

    <!-- React 18 via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script>
      const API_BASE = "http://127.0.0.1:5000";

      async function request(path, options) {
        const res = await fetch(API_BASE + path, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (!res.ok) throw new Error(await res.text());
        return res.status === 204 ? null : res.json();
      }

      const api = {
        hello: () => request("/api/hello"),
        list: () => request("/api/todos"),
        add: (text) => request("/api/todos", { method: "POST", body: JSON.stringify({ text }) }),
        toggle: (id) => request("/api/todos/" + id, { method: "PATCH" }),
      };

      const e = React.createElement;
      function TodoForm({ onAdd }) {
        const [text, setText] = React.useState("");
        function submit(ev) {
          ev.preventDefault();
          const v = text.trim();
          if (!v) return;
          onAdd(v);
          setText("");
        }
        return e("form", { onSubmit: submit, style: { display:"flex", gap:8, marginBottom:12 } },
          e("input", { placeholder:"New todo", value:text, onChange: ev => setText(ev.target.value) }),
          e("button", { type:"submit" }, "Add")
        );
      }

      function TodoList({ todos, onToggle }) {
        if (!todos.length) return e("p", null, "No todos yet.");
        return e("ul", { style:{ listStyle:"none", padding:0 } },
          ...todos.map(t => e("li", { key:t.id, style:{ display:"flex", gap:8, alignItems:"center", marginBottom:6 } },
            e("input", { type:"checkbox", checked:t.done, onChange:() => onToggle(t.id) }),
            e("span", { style:{ textDecoration: t.done ? "line-through" : "none" } }, t.text)
          ))
        );
      }

      function App() {
        const [hello, setHello] = React.useState("");
        const [todos, setTodos] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState("");

        async function load() {
          try {
            setLoading(true);
            const [h, t] = await Promise.all([api.hello(), api.list()]);
            setHello(h.message);
            setTodos(t);
            setError("");
          } catch (err) {
            setError(String(err));
          } finally {
            setLoading(false);
          }
        }

        React.useEffect(() => { load(); }, []);

        async function addTodo(text) {
          await api.add(text);
          load();
        }
        async function toggle(id) {
          await api.toggle(id);
          load();
        }

        return e(React.Fragment, null,
          e("p", { style:{ opacity:0.8 } }, hello || "…"),
          e(TodoForm, { onAdd: addTodo }),
          loading ? e("p", null, "Loading…")
                  : error ? e("p", { style:{ color:"red" } }, error)
                          : e(TodoList, { todos, onToggle: toggle })
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(e(App));
    </script>
  </body>
</html>
